<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Voxiom Crate Opening Simulator</title>
  <style>
    body { margin: 0; overflow: hidden; background: #0a0a1f; font-family: Arial, sans-serif; }
    canvas { display: block; }
    #ui {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 10px;
      max-width: 350px;
      pointer-events: auto;
    }
    button {
      padding: 12px 20px;
      font-size: 18px;
      background: #4a148c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover { background: #7b1fa2; }
    #result {
      margin-top: 15px;
      font-size: 16px;
      min-height: 40px;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h2>Voxiom Crate Simulator</h2>
    <button id="openBtn">Open Advanced Crate (100 gems)</button>
    <p id="result">Click to open a crate!</p>
  </div>

  <script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/loaders/GLTFLoader.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/OrbitControls.js';

  // ─── Scene Setup ────────────────────────────────────────────────────────────
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a1f);

  const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
  camera.position.set(0, 1.2, 4);

  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.shadowMap.enabled = true;
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 2;
  controls.maxDistance = 10;

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.7));
  const dirLight = new THREE.DirectionalLight(0xffffff, 2);
  dirLight.position.set(5, 10, 7);
  dirLight.castShadow = true;
  scene.add(dirLight);

  const loader = new GLTFLoader();

  // ─── Models & Variables ─────────────────────────────────────────────────────
  let crateModel = null;
  let currentItem = null;
  let isOpening = false;

  // Load crate (optional - fallback if missing)
  loader.load('./models/crate.glb', (gltf) => {
    crateModel = gltf.scene;
    crateModel.scale.set(1.8, 1.8, 1.8);
    crateModel.position.y = 0.5;
    scene.add(crateModel);
    console.log("Crate loaded!");
  }, undefined, () => {
    console.warn("Crate not found — using fallback.");
    const geo = new THREE.BoxGeometry(1.5, 1.5, 1.5);
    const mat = new THREE.MeshStandardMaterial({ color: 0x6a1b9a });
    crateModel = new THREE.Mesh(geo, mat);
    crateModel.position.y = 0.75;
    scene.add(crateModel);
  });

  // ─── Apply Psychic Twist Skin ───────────────────────────────────────────────
  function applyPsychicTwist(gun) {
    const texLoader = new THREE.TextureLoader();
    texLoader.load('./textures/psychic.png', (tex) => {
      tex.flipY = false;
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping;

      gun.traverse((child) => {
        if (child.isMesh && child.material) {
          if (child.material.map) {
            child.material.map = tex;
            child.material.needsUpdate = true;
          }
          child.material.emissive = new THREE.Color(0x7e57c2);
          child.material.emissiveIntensity = 0.25;
        }
      });
      console.log("Psychic Twist applied!");
    });
  }

  // ─── Show AK with Psychic Twist ─────────────────────────────────────────────
  function showPsychicTwistAK() {
    if (currentItem) scene.remove(currentItem);

    loader.load('./models/ak.glb', (gltf) => {
      currentItem = gltf.scene;
      currentItem.scale.set(1.6, 1.6, 1.6);
      currentItem.position.set(0, 1, 0);
      currentItem.rotation.y = Math.PI;

      scene.add(currentItem);
      applyPsychicTwist(currentItem);

      // Reveal animation
      currentItem.visible = false;
      setTimeout(() => {
        currentItem.visible = true;
        gsap.to(currentItem.rotation, { y: Math.PI * 4, duration: 3, ease: "power2.out" });
        gsap.to(currentItem.position, { y: 1.5, duration: 1.5, yoyo: true, repeat: 1 });
      }, 800);

      document.getElementById('result').innerHTML = 
        '<span style="color:#ba68c8;font-weight:bold;">Magnificent Drop!</span><br>Psychic Twist on Combat Assault Rifle (AK)';
    }, undefined, (err) => {
      console.error("AK load error:", err);
      document.getElementById('result').textContent = "Error loading AK — check file path/console.";
    });
  }

  // ─── Open Button ────────────────────────────────────────────────────────────
  document.getElementById('openBtn').addEventListener('click', () => {
    if (isOpening) return;
    isOpening = true;
    document.getElementById('result').textContent = "Opening crate...";

    setTimeout(() => {
      showPsychicTwistAK();
      if (crateModel) {
        gsap.to(crateModel.rotation, { y: Math.PI * 2, duration: 2, ease: "power1.inOut" });
      }
      setTimeout(() => { isOpening = false; }, 4000);
    }, 1500);
  });

  // ─── Animate ────────────────────────────────────────────────────────────────
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // GSAP for smooth animations
  const gsapScript = document.createElement('script');
  gsapScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js';
  document.head.appendChild(gsapScript);
</script>
</body>
</html>
